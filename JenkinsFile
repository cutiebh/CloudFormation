pipeline {
  agent any

  parameters {
    string(name: 'STUDENT_ID',  defaultValue: 'STU123456', description: 'Student ID')
    choice(name: 'STAGENAME',  choices: ['dev'], description: 'Environment')
    string(name: 'GIT_REPO',    defaultValue: 'https://github.com/cutiebh/CloudFormation.git', description: 'Repo URL')
    string(name: 'GIT_BRANCH',  defaultValue: 'main', description: 'Branch')
    string(name: 'AWS_REGION',  defaultValue: 'us-east-1', description: 'AWS region')
    string(name: 'CFN_TEMPLATE', defaultValue: 'booklist-lambda-restapi.yaml', description: 'CFN template path')
    booleanParam(name: 'SKIP_DEPLOY',  defaultValue: false)
    booleanParam(name: 'SKIP_API',     defaultValue: false)
    booleanParam(name: 'SKIP_DESTROY', defaultValue: false)
 
  }

  environment {
    APP_NAME           = 'jenkins-windows-cfn-demo'
    CFN_STACK_NAME     = "BookListStack"
    AWS_DEFAULT_REGION = "${params.AWS_REGION}"
  }

  stages {
      
      stage('Checkout Repository') {
      steps {
        echo "Checking out %GIT_REPO% @ %GIT_BRANCH% ..."
        // Simple built-in git step
        git branch: "${params.GIT_BRANCH}", url: "${params.GIT_REPO}"
      }
    }

    stage('Deploy CloudFormation') {
      steps {
          
           script {
                    if (params.SKIP_DEPLOY) return
                }
           withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
      credentialsId: 'aws_default',
      accessKeyVariable: 'AWS_ACCESS_KEY_ID',
      secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
        bat """
        echo Workspace: %WORKSPACE%
          aws cloudformation deploy ^
            --template-file "%WORKSPACE%\\booklist-lambda-restapi.yaml" ^
            --stack-name "%CFN_STACK_NAME%" ^
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM ^
            --parameter-overrides StudentId=%STUDENT_ID% StageName=%STAGENAME% ^
            --no-fail-on-empty-changeset
        """
      }
      }
    }

    
    stage('Call API') {
  steps {
      withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
      credentialsId: 'aws_default',
      accessKeyVariable: 'AWS_ACCESS_KEY_ID',
      secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
    bat '''
    @echo off
      rem setlocal enabledelayedexpansion
      for /f "usebackq delims=" %%A in (
            `aws cloudformation describe-stacks --stack-name "BookListStack" --region us-east-1 --query "Stacks[0].Outputs[?OutputKey=='InvokeUrl'].OutputValue" --output text
        `) do (
        set API_URL=%%A
        )

    endlocal & set "API_URL=%API_URL%"

      if /I "%API_URL%"=="None" set API_URL=

      rem If no URL, skip without error
      if "%API_URL%"=="" goto :eof
      @echo on
      echo API url : %API_URL%
      curl -X GET "%API_URL%" -H "x-api-key: SID-STU123456-0000000000000000"
    '''
      }
  }
}



    stage('Destroy CloudFormation') {
      steps {
           script {
                    if (params.SKIP_DESTROY) return
                }
          
            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
      credentialsId: 'aws_default',
      accessKeyVariable: 'AWS_ACCESS_KEY_ID',
      secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
        bat """
          aws cloudformation delete-stack --stack-name "%CFN_STACK_NAME%"
        """
      }
      }
    }
  }
}
